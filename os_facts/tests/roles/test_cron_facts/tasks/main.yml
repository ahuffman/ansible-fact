---
- name: "cron_facts tests"
  block:
    - name: "Create a sample file with no permissions"
      file:
        path: "{{ no_permissions_file }}"
        mode: "000"
        state: "touch"
      notify: "cleanup"

    - name: "Attempt to load a file with no permissions"
      cron_facts:
        cron_files:
          - "{{ no_permissions_file }}"
      ignore_errors: True
      register: "read_failure"

    - debug:
        var: "read_failure"

    - assert:
        that:
          - "read_failure is failed"
          - "'Permission denied' in read_failure.msg"

    - name: "Set the permissions to 644 for assertion"
      file:
        path: "roles/test_cron_facts/files/crontabs/var/spool/cron/root/test_1"
        mode: "0644"
        state: "touch"

    - name: "Load the test_1 crontab"
      cron_facts:
        cron_files:
          - "roles/test_cron_facts/files/crontabs/var/spool/cron/root/test_1"

    - debug:
        msg:
          - "Here are the assertion values we are going to look at:"
          - "{{ cron.files | length() }} == 1"
          - "{{ cron.files[0]['path'] }} == 'roles/test_cron_facts/files/crontabs/var/spool/cron/root/test_1'"
          - "{{ cron.files[0]['permissions'] }} == '0644'"
          - "'user' in {{ cron.files[0] }}"
          - "'group' in {{ cron.files[0] }}"
          - "{{ cron.all_scanned_files | length() }} == 1"
          - "{{ cron.all_scanned_files[0]['configuration'] | length() }} == 57"
          - "{{ cron.all_scanned_files[0]['data']['schedules'] | length() }} == 19"
          - "'timeperiod' not in {{ cron.all_scanned_files[0]['data']['schedules'][0] }}"

    - name: "Validate that all cronjobs were loaded"
      assert:
        that:
          - "cron.files | length() == 1"
          - "cron.files[0]['path'] == 'roles/test_cron_facts/files/crontabs/var/spool/cron/root/test_1'"
          - "cron.files[0]['permissions'] == '0644'"
          - "'user' in cron.files[0]"
          - "'group' in cron.files[0]"
          - "cron.all_scanned_files | length() == 1"
          - "cron.all_scanned_files[0]['configuration'] | length() == 57"
          - "cron.all_scanned_files[0]['data']['schedules'] | length() == 19"
          - "'timeperiod' not in cron.all_scanned_files[0]['data']['schedules'][0]"
  become: False
