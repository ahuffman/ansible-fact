---
- name: "Initiate tests"
  hosts: "localhost"
  gather_facts: False
  tasks:
    - debug:
        msg: "Initiating test playbook runs"

    # Dynamic test role locatator to avoid manual test playbook builds later
    - name: "Locate test roles"
      find:
        paths:
          - "roles"
        recurse: False
        file_type: "directory"
      register: "test_roles"

    - name: "Set test roles list"
      set_fact:
        testing_roles: "{{ test_roles.files | json_query('[*].path') }}"

    - name: "Output discovered testing roles"
      debug:
        var: "testing_roles"

# instantiate tests from dynamically discovered roles
- name: "Run ansible-fact tests"
  hosts: "localhost"
  gather_facts: False
  force_handlers: True
  collections:
    - "ansible_fact.os_facts"
  tasks:
    - name: "Include testing roles"
      include_role:
        name: "{{ item | basename }}"
        apply:
          ansible_user: "travis"
          become_user: "root"
          become_method: "su"
      with_items: "{{ testing_roles }}"
